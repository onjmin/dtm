<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç°¡æ˜“DAW (MMLã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼) ãƒ‡ãƒ¢</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/gh/KazuProg/mml-player@main/dist/mml-player.js"></script>

    <script type="module">
        import * as mdi from 'https://cdn.jsdelivr.net/npm/@mdi/js@7.4.47/mdi.js';

        // ã€é‡è¦ã€‘ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«APIã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’æ–°ã—ã„è¨­è¨ˆã«åˆã‚ã›ã‚‹
        const dtm = await import('http://localhost:40298/dist/index.mjs');
        const MMLCore = dtm.MMLCore;
        const { init, onClick, drawGrid, drawNotes, getActiveContext } = dtm; // æ–°ã—ã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«APIã‚’æƒ³å®š
        // ----------------------------------------------------------------------

        console.log('DTM ãƒ‡ãƒ¢ - ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');

        // --- çŠ¶æ…‹ç®¡ç† ---
        const renderOptions = {
            keyHeight: 15,
            stepWidth: 10,
        };

        const tracks = [
            // rendererã¯ä¸è¦ã«ãªã‚Šã€isVisibleã¨activeTrackIdã§æç”»ã‚’åˆ¶å¾¡
            { id: 'melody', name: 'ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼', instrument: 0, core: null, volume: 80, mml: '', isVisible: true },
            { id: 'bass', name: 'ãƒ™ãƒ¼ã‚¹', instrument: 1, core: null, volume: 70, mml: '', isVisible: false },
            { id: 'chord', name: 'ä¼´å¥', instrument: 2, core: null, volume: 60, mml: '', isVisible: false },
        ];
        let activeTrackId = 'melody';
        let isPlaying = false;
        let noteLengthSteps = 1; // 16åˆ†éŸ³ç¬¦
        let mmlPlayer = null;

        // ----------------------------------------------------------------------

        // å…¨ãƒˆãƒ©ãƒƒã‚¯ã‚’å†æç”»ã™ã‚‹ãƒ¡ã‚¤ãƒ³ã®é–¢æ•°
        const redrawAll = () => {
            // ğŸš¨ ä¿®æ­£: tracks[0].core ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å‡¦ç†ã‚’ä¸­æ–­ ğŸš¨
            if (!tracks[0] || !tracks[0].core) {
                return;
            }

            // 1. ã‚°ãƒªãƒƒãƒ‰ã®æç”»ã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ä¾é ¼ï¼ˆèƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢ï¼‰
            drawGrid(tracks[0].core.getConfig(), renderOptions);

            // 2. isVisibleãªãƒˆãƒ©ãƒƒã‚¯ã®ãƒãƒ¼ãƒˆã‚’æç”»
            tracks.forEach(track => {
                // ãƒãƒ¼ãƒˆãŒå¤‰æ›´ã•ã‚ŒãŸãƒˆãƒ©ãƒƒã‚¯ã® core ã¯å­˜åœ¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹ãŒã€
                // ä»–ã®ãƒˆãƒ©ãƒƒã‚¯ã® core ã‚‚ãƒã‚§ãƒƒã‚¯ã™ã‚‹å®‰å…¨ç­–
                if (track.isVisible && track.core) {
                    drawNotes(
                        track.core.getNotes(),
                        track.core.getConfig(),
                        renderOptions,
                        // ãƒˆãƒ©ãƒƒã‚¯ã”ã¨ã«ãƒãƒ¼ãƒˆã®è‰²ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ãªã©
                        { color: track.id === 'melody' ? '#3B82F6' : (track.id === 'bass' ? '#10B981' : '#F59E0B') }
                    );
                }
            });
        };

        // MMLå‡ºåŠ›ã‚¨ãƒªã‚¢æ›´æ–° (æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«ç§»å‹•)
        const updateMMLOutput = () => {
            const fullMML = `t120 l16 ${tracks.map((t, i) => `@${i} ${t.mml}`).join(';')}`;
            document.getElementById('mml-output').textContent = fullMML;
            document.getElementById('mml-output-status').textContent =
                `(${tracks.length}ãƒˆãƒ©ãƒƒã‚¯) MMLæ–‡å­—æ•°: ${fullMML.length}`;
        };

        // UIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ›´æ–° (æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«ç§»å‹•)
        const updateControls = () => {
            // ... (çœç•¥: å†ç”Ÿãƒœã‚¿ãƒ³ã¨ãƒˆãƒ©ãƒƒã‚¯ã‚¿ãƒ–ã®HTMLã‚’æ›´æ–°ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯) ...

            // å†ç”Ÿãƒœã‚¿ãƒ³
            const playButton = document.getElementById('play-button');
            playButton.className = `px-4 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 ${isPlaying ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-green-500 hover:bg-green-600 text-white'}`;
            playButton.innerHTML = isPlaying
                ? `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="${mdi.mdiStop}"></path></svg><span>åœæ­¢</span>`
                : `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="${mdi.mdiPlay}"></path></svg><span>è©¦è´</span>`;

            // ãƒˆãƒ©ãƒƒã‚¯ã‚¿ãƒ–ã¨éŸ³é‡ (isActiveã®åˆ¤å®šã‚’isVisibleã§ã¯ãªãactiveTrackIdã§å¼•ãç¶šãè¡Œã†)
            const trackTabs = document.getElementById('track-tabs');
            const trackContent = document.getElementById('track-content');

            trackTabs.innerHTML = '';
            trackContent.innerHTML = '';

            tracks.forEach(t => {
                // ã‚¿ãƒ–
                const isActive = t.id === activeTrackId;
                const tabClass = `px-4 py-2 text-sm font-medium transition-colors cursor-pointer rounded-t-lg ${isActive ? 'bg-white border-x border-t border-gray-200 text-purple-600 -mb-px' : 'bg-gray-100 hover:bg-gray-200 text-gray-700 border-b border-gray-200'}`;
                trackTabs.innerHTML += `<button onclick="switchTrack('${t.id}')" class="${tabClass}">${t.name}</button>`;

                // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
                if (isActive) {
                    trackContent.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center space-x-3 w-64 text-sm text-gray-700">
                            <span class="font-medium">éŸ³é‡:</span>
                            <span id="volume-label-${t.id}" class="w-8 text-right font-mono">${t.volume}</span>
                            <input
                                type="range"
                                min="0"
                                max="100"
                                step="1"
                                value="${t.volume}"
                                oninput="handleVolumeChange('${t.id}', this.value)"
                                class="flex-1 h-2 bg-purple-100 rounded-lg appearance-none cursor-pointer accent-purple-500"
                            />
                        </label>
                        <span class="text-sm text-gray-500">éŸ³è‰²: @${t.instrument}</span>
                    </div>
                `;
                }
            });
        };

        // åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
        const initializeDemo = () => {
            const pianoRollContainer = document.getElementById('piano-roll-container');
            const mmlOutput = document.getElementById('mml-output');
            const noteLengthSelect = document.getElementById('note-length-select');

            // 0. MMLPlayer åˆæœŸåŒ–
            if (typeof window.MMLPlayer === 'undefined') {
                console.error("mml-player.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }
            mmlPlayer = new window.MMLPlayer();

            // 2. Core/Renderer ã®åˆæœŸåŒ–
            const coreConfig = {
                bars: 8,
                stepsPerBar: 16,
                keyCount: 49, // C1ã€œC5
                pitchRangeStart: 0,
            };

            // 1. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã« Canvas ã®åˆæœŸåŒ–ã‚’ä¾é ¼ (DOMæ“ä½œã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®æŠ½è±¡åŒ–)
            // #piano-roll-container ã®ç¾åœ¨ã®CSSã‚µã‚¤ã‚ºã‚’æ¸¡ã™: w-[800px] h-[450px]
            init(
                pianoRollContainer.querySelector('#wrapper'),
                coreConfig, // MMLCore ã®è¨­å®šã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«æ¸¡ã™
                renderOptions, // æç”»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«æ¸¡ã™
                800,
                450
            );

            tracks.forEach(track => {
                // MMLCore ã®åˆæœŸåŒ–
                track.core = new MMLCore({
                    onMMLGenerated: (mml) => {
                        track.mml = mml;
                        updateMMLOutput();
                    },
                    onNotesChanged: (notes) => {
                        // ãƒãƒ¼ãƒˆãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã€å…¨ä½“ã‚’å†æç”»
                        redrawAll();
                    },
                }, coreConfig);

                track.core.setVolume(track.volume);
            });

            // 3. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š

            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ç™»éŒ²
            onClick((step, pitch) => {

                // ãƒ­ã‚°ã§å‹•ä½œç¢ºèª (ä¸€æ™‚çš„ã«è¿½åŠ )
                console.log(`Clicked Grid: Step=${step}, Pitch=${pitch}`);

                const activeTrack = tracks.find(t => t.id === activeTrackId);
                if (!activeTrack) return;
                activeTrack.core.toggleNote(step, pitch, {
                    noteLengthSteps: noteLengthSteps,
                });
            });


            // 4. åˆæœŸæç”»
            updateControls();
            updateMMLOutput();
            redrawAll(); // åˆå›ã‚°ãƒªãƒƒãƒ‰æç”»ã¨ãƒãƒ¼ãƒˆæç”» (ãƒãƒ¼ãƒˆã¯ç©º)

            document.getElementById('play-button').disabled = false;
        };

        // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã«åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
        initializeDemo();

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•° (UIã‹ã‚‰ã®å‘¼ã³å‡ºã—ç”¨) ---

        window.switchTrack = (id) => {
            activeTrackId = id;
            // isVisibleãƒ•ãƒ©ã‚°ã‚’æ“ä½œã—ã€redrawAllã§åˆ‡ã‚Šæ›¿ãˆã‚‹æ–¹æ³•ã‚‚ã‚ã‚‹ãŒã€ä»Šå›ã¯ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒˆãƒ©ãƒƒã‚¯ã‚’ç·¨é›†å¯¾è±¡ã¨ã™ã‚‹
            // æç”»è‡ªä½“ã¯ã€å…¨ã¦ã® visible ãªãƒˆãƒ©ãƒƒã‚¯ã‚’æç”»ã™ã‚‹
            updateControls();
            redrawAll(); // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒˆãƒ©ãƒƒã‚¯ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰å…¨ä½“ã‚’å†æç”»
        };

        window.handleVolumeChange = (id, value) => {
            const track = tracks.find(t => t.id === id);
            if (track) {
                track.volume = parseInt(value);
                track.core.setVolume(track.volume);
                document.getElementById(`volume-label-${id}`).textContent = track.volume;
                // ãƒœãƒªãƒ¥ãƒ¼ãƒ ã¯MMLã«åæ˜ ã•ã‚Œã‚‹
                track.core.generateMML();
            }
        };

        window.togglePlayback = () => {
            if (isPlaying) {
                mmlPlayer.stop();
                isPlaying = false;
            } else {
                const fullMML = tracks.map(t => t.mml).join(';');
                mmlPlayer.play(fullMML);
                isPlaying = true;
            }
            updateControls();
        };

        const noteLengthSelect = document.getElementById('note-length-select');
        noteLengthSelect.addEventListener('change', (e) => {
            noteLengthSteps = parseInt(e.target.value);
            // Note: ã™ã¹ã¦ã®ãƒˆãƒ©ãƒƒã‚¯ã®Rendererã«è¨­å®šã™ã‚‹å¿…è¦ãŒãªããªã£ãŸãŸã‚ã€çŠ¶æ…‹å¤‰æ•°ã®ã¿æ›´æ–°
        });
    </script>
</head>

<body class="bg-gray-100 p-4 min-h-screen">
    <h1 class="text-3xl font-extrabold mb-4 text-gray-800">ç°¡æ˜“DAWï¼ˆCanvas/MMLï¼‰ãƒ‡ãƒ¢</h1>

    <div class="flex flex-wrap gap-4 p-4 bg-white border rounded-lg shadow-md mb-6">

        <button id="play-button" onclick="togglePlayback()" disabled class="px-4 py-2 bg-gray-300 rounded"></button>

        <div class="flex items-center space-x-2">
            <span class="text-sm font-medium text-gray-700">ãƒãƒ¼ãƒˆé•·:</span>
            <select id="note-length-select"
                class="border rounded-md px-2 py-1 text-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="4">4åˆ†</option>
                <option value="2">8åˆ†</option>
                <option value="1" selected>16åˆ†</option>
            </select>
        </div>

        <div class="flex items-center space-x-2 border-l border-gray-200 pl-4">
            <span class="text-sm font-medium text-gray-700">ãƒ‰ãƒ©ãƒ  (Track 4):</span>
            <select id="drum-select"
                class="border rounded-md px-2 py-1 text-sm focus:ring-blue-500 focus:border-blue-500">
                <option>ãªã—</option>
                <option>4ã¤æ‰“ã¡</option>
                <option>ãƒ­ãƒƒã‚¯</option>
            </select>
            <span class="text-xs text-gray-500">(MMLå†ç”Ÿã«ã¯å«ã¾ãš)</span>
        </div>
    </div>

    <div class="p-4 bg-white border rounded-lg shadow-md mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">ãƒˆãƒ©ãƒƒã‚¯è¨­å®š</h2>

        <div id="track-tabs" class="flex border-b border-gray-200">
        </div>

        <div id="track-content" class="p-4 border border-t-0 border-gray-200 rounded-b-lg bg-white">
        </div>
    </div>

    <div id="piano-roll-container"
        class="w-[800px] h-[450px] bg-white border border-gray-300 rounded-lg shadow-xl relative"
        style="overflow: auto;">
        <div id="wrapper" class="absolute inset-0">
        </div>
    </div>

    <hr class="my-6 border-gray-300">

    <div class="p-4 bg-gray-800 text-white rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold mb-2">ç”Ÿæˆã•ã‚ŒãŸ MML</h2>
        <p id="mml-output-status" class="text-xs mb-2 text-gray-400"></p>
        <pre class="bg-black p-3 rounded-md overflow-x-auto text-sm">
            <code id="mml-output"></code>
        </pre>
    </div>
</body>

</html>