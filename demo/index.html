<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>簡易DAW (MMLジェネレーター) デモ</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/@kazuprog/mml-player@1.0.0/dist/mml-player.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" />


    <script type="module">
        import * as mdi from 'https://cdn.jsdelivr.net/npm/@mdi/js@7.4.47/mdi.js';

        const DTM = await import(
            location.hostname === 'localhost' ?
                'http://localhost:40298/dist/index.mjs' :
                'https://onjmin.github.io/dtm/demo/index.mjs');

        const renderConfig = {
            bars: 8,
            stepsPerBar: 16,
            keyCount: 49, // C1〜C5
            pitchRangeStart: 0,
            keyHeight: 15,
            stepWidth: 10,
        };

        const hexToRgb = (hex) =>
            [0, 1, 2].map(i => parseInt(hex.slice(1 + i * 2, 3 + i * 2), 16))
        const tracks = [
            { id: 'melody', name: 'メロディー', color: hexToRgb('#3B82F6'), instrument: 0, core: null, volume: 80, mml: '' },
            { id: 'bass', name: 'ベース', color: hexToRgb('#10B981'), instrument: 1, core: null, volume: 70, mml: '' },
            { id: 'chord', name: '伴奏', color: hexToRgb('#F59E0B'), instrument: 2, core: null, volume: 60, mml: '' },
        ];
        let activeTrackId = 'melody';
        let isPlaying = false;
        let noteLengthSteps = 1; // 16分音符
        let mmlPlayer = null;

        let currentOffsetX = 0;
        let currentOffsetY = 0;
        const scrollAmount = 16 * renderConfig.stepWidth; // 例: 1小節分を移動量とする

        // ----------------------------------------------------------------------

        window.movePianoRoll = (direction) => {
            const { keyHeight, keyCount } = renderConfig;

            switch (direction) {
                case 'right':
                    currentOffsetX += scrollAmount;
                    break;
                case 'left':
                    currentOffsetX = Math.max(0, currentOffsetX - scrollAmount);
                    break;
                case 'up':
                    currentOffsetY -= keyHeight;
                    break;
                case 'down':
                    currentOffsetY += keyHeight;
                    break;
            }

            DTM.setDrawOffset(currentOffsetX, currentOffsetY);

            // 再描画
            redrawAll();
        };

        // 全トラックを再描画するメインの関数
        const redrawAll = () => {
            DTM.drawGrid();

            tracks.forEach((track, i) => {
                if (!track.core) return;
                const [r, g, b] = track.color;
                const a = track.id === activeTrackId
                    ? 1
                    : 0.3;
                DTM.drawNotes(
                    track.core.getNotes(),
                    `rgba(${r},${g},${b},${a})`
                );
            });
        };

        // MML出力エリア更新 (既存ロジックをトップレベルに移動)
        const updateMMLOutput = () => {
            const fullMML = `t120 l16 ${tracks.map((t, i) => `@${i} ${t.mml}`).join(';')}`;
            document.getElementById('mml-output').textContent = fullMML;
            document.getElementById('mml-output-status').textContent =
                `(${tracks.length}トラック) MML文字数: ${fullMML.length}`;
        };

        // UIコントロール更新 (既存ロジックをトップレベルに移動)
        const updateControls = () => {
            // ... (省略: 再生ボタンとトラックタブのHTMLを更新するロジック) ...

            // 再生ボタン
            const playButton = document.getElementById('play-button');
            playButton.className = `px-4 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 ${isPlaying ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-green-500 hover:bg-green-600 text-white'}`;
            playButton.innerHTML = isPlaying
                ? `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="${mdi.mdiStop}"></path></svg><span>停止</span>`
                : `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="${mdi.mdiPlay}"></path></svg><span>試聴</span>`;

            const trackTabs = document.getElementById('track-tabs');
            const trackContent = document.getElementById('track-content');

            trackTabs.innerHTML = '';
            trackContent.innerHTML = '';

            tracks.forEach(t => {
                // タブ
                const isActive = t.id === activeTrackId;
                const tabClass = `px-4 py-2 text-sm font-medium transition-colors cursor-pointer rounded-t-lg ${isActive ? 'bg-white border-x border-t border-gray-200 text-purple-600 -mb-px' : 'bg-gray-100 hover:bg-gray-200 text-gray-700 border-b border-gray-200'}`;
                trackTabs.innerHTML += `<button onclick="switchTrack('${t.id}')" class="${tabClass}">${t.name}</button>`;

                // コンテンツ
                if (isActive) {
                    trackContent.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center space-x-3 w-64 text-sm text-gray-700">
                            <span class="font-medium">音量:</span>
                            <span id="volume-label-${t.id}" class="w-8 text-right font-mono">${t.volume}</span>
                            <input
                                type="range"
                                min="0"
                                max="100"
                                step="1"
                                value="${t.volume}"
                                oninput="handleVolumeChange('${t.id}', this.value)"
                                class="flex-1 h-2 bg-purple-100 rounded-lg appearance-none cursor-pointer accent-purple-500"
                            />
                        </label>
                        <span class="text-sm text-gray-500">音色: @${t.instrument}</span>
                    </div>
                `;
                }
            });
        };

        // 初期化処理を実行
        const initializeDemo = () => {
            const pianoRollContainer = document.getElementById('piano-roll-container');
            const mmlOutput = document.getElementById('mml-output');
            const noteLengthSelect = document.getElementById('note-length-select');

            // 0. MMLPlayer 初期化
            if (typeof window.MMLPlayer === 'undefined') {
                console.error("mml-player.jsが読み込まれていません。");
                return;
            }
            mmlPlayer = new window.MMLPlayer();

            // 2. Core/Renderer の初期化
            const pianoRollConfig = {
                bars: 8,
                stepsPerBar: 16,
                keyCount: 49, // C1〜C5
                pitchRangeStart: 0,
                keyHeight: 15,
                stepWidth: 10,
            };

            // 1. モジュールに Canvas の初期化を依頼 (DOM操作とイベントリスナーの抽象化)
            // #piano-roll-container の現在のCSSサイズを渡す: w-[800px] h-[450px]
            DTM.init(
                pianoRollContainer.querySelector('#wrapper'),
                800,
                450,
                renderConfig,
            );

            tracks.forEach(track => {
                track.core = new DTM.MMLCore({
                    onMMLGenerated: (mml) => {
                        track.mml = mml;
                        updateMMLOutput();
                    },
                    onNotesChanged: (notes) => {
                        redrawAll();
                    },
                });

                track.core.setVolume(track.volume);
            });

            // 3. イベントリスナーの設定

            // クリックイベントをモジュールに登録
            DTM.onClick((step, pitch) => {

                // ログで動作確認 (一時的に追加)
                console.log(`Clicked Grid: Step=${step}, Pitch=${pitch}`);

                const activeTrack = tracks.find(t => t.id === activeTrackId);
                if (!activeTrack) return;
                activeTrack.core.toggleNote(step, pitch, {
                    noteLengthSteps: noteLengthSteps,
                });
            });


            // 4. 初期描画
            updateControls();
            updateMMLOutput();
            redrawAll(); // 初回グリッド描画とノート描画 (ノートは空)

            document.getElementById('play-button').disabled = false;
        };

        // モジュールロード完了後に初期化を実行
        initializeDemo();

        // --- グローバル関数 (UIからの呼び出し用) ---

        window.switchTrack = (id) => {
            activeTrackId = id;
            updateControls();
            redrawAll();
        };

        window.handleVolumeChange = (id, value) => {
            const track = tracks.find(t => t.id === id);
            if (track) {
                track.volume = parseInt(value);
                track.core.setVolume(track.volume);
                document.getElementById(`volume-label-${id}`).textContent = track.volume;
                // ボリュームはMMLに反映される
                track.core.generateMML();
            }
        };

        window.togglePlayback = () => {
            if (isPlaying) {
                mmlPlayer.stop();
                isPlaying = false;
            } else {
                const fullMML = tracks.map(t => t.mml).join(';');
                mmlPlayer.play(fullMML);
                isPlaying = true;
            }
            updateControls();
        };

        const noteLengthSelect = document.getElementById('note-length-select');
        noteLengthSelect.addEventListener('change', (e) => {
            noteLengthSteps = parseInt(e.target.value);
            // Note: すべてのトラックのRendererに設定する必要がなくなったため、状態変数のみ更新
        });
    </script>
</head>

<body class="bg-gray-100 p-4 min-h-screen">
    <h1 class="text-3xl font-extrabold mb-4 text-gray-800">簡易DAW（Canvas/MML）デモ</h1>

    <div class="flex flex-wrap gap-4 p-4 bg-white border rounded-lg shadow-md mb-6">

        <button id="play-button" onclick="togglePlayback()" disabled class="px-4 py-2 bg-gray-300 rounded"></button>

        <div class="flex items-center space-x-2">
            <span class="text-sm font-medium text-gray-700">ノート長:</span>
            <select id="note-length-select"
                class="border rounded-md px-2 py-1 text-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="4">4分</option>
                <option value="2">8分</option>
                <option value="1" selected>16分</option>
            </select>
        </div>

        <div class="flex items-center space-x-2 border-l border-gray-200 pl-4">
            <span class="text-sm font-medium text-gray-700">ドラム (Track 4):</span>
            <select id="drum-select"
                class="border rounded-md px-2 py-1 text-sm focus:ring-blue-500 focus:border-blue-500">
                <option>なし</option>
                <option>4つ打ち</option>
                <option>ロック</option>
            </select>
            <span class="text-xs text-gray-500">(MML再生には含まず)</span>
        </div>
    </div>

    <div class="p-4 bg-white border rounded-lg shadow-md mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">トラック設定</h2>

        <div id="track-tabs" class="flex border-b border-gray-200">
        </div>

        <div id="track-content" class="p-4 border border-t-0 border-gray-200 rounded-b-lg bg-white">
        </div>
    </div>


    <div class="flex justify-center space-x-4 mb-2">
        <div class="flex space-x-1">
            <button onclick="movePianoRoll('left')"
                class="p-2 bg-gray-300 hover:bg-gray-400 rounded-lg transition-colors">
                <i class="mdi mdi-chevron-left text-xl"></i>
            </button>
            <button onclick="movePianoRoll('right')"
                class="p-2 bg-gray-300 hover:bg-gray-400 rounded-lg transition-colors">
                <i class="mdi mdi-chevron-right text-xl"></i>
            </button>
            <span class="text-sm self-center text-gray-600 ml-2">水平移動 (1小節)</span>
        </div>

        <div class="flex space-x-1 border-l border-gray-300 pl-4">
            <button onclick="movePianoRoll('up')"
                class="p-2 bg-gray-300 hover:bg-gray-400 rounded-lg transition-colors">
                <i class="mdi mdi-chevron-up text-xl"></i>
            </button>
            <button onclick="movePianoRoll('down')"
                class="p-2 bg-gray-300 hover:bg-gray-400 rounded-lg transition-colors">
                <i class="mdi mdi-chevron-down text-xl"></i>
            </button>
            <span class="text-sm self-center text-gray-600 ml-2">垂直移動 (1キー)</span>
        </div>
    </div>


    <div id="piano-roll-container"
        class="w-[800px] h-[450px] bg-white border border-gray-300 rounded-lg shadow-xl relative"
        style="overflow: hidden;">
        <div id="wrapper" class="absolute inset-0">
        </div>
    </div>

    <hr class="my-6 border-gray-300">

    <div class="p-4 bg-gray-800 text-white rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold mb-2">生成された MML</h2>
        <p id="mml-output-status" class="text-xs mb-2 text-gray-400"></p>
        <pre class="bg-black p-3 rounded-md overflow-x-auto text-sm">
            <code id="mml-output"></code>
        </pre>
    </div>
</body>

</html>